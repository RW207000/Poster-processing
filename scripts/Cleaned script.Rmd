---
title: "Cleaned script for Feb 2025 I-CAH data analysis"
author: "R.Welch"
date: "2024-11-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*********************************
*********************************
------Script set up------

libraries
```{r : reading libraries, include= FALSE}
packages <- c("tidyverse", "readxl", "dplyr", "magrittr", "mixtools", "emmeans", "readr","data.table", "lubridate", "ggplot2", "skimr", "ggstatsplot","summarytools", "knitr", "here", "ggthemes", "Amelia", "tidyr", "naniar", "stringr", "janitor")

lapply(packages, library, character.only = TRUE)
```

Reading in original data.
```{r : reading in data}
participants <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/data/Core only 24.02.2025.csv", header=T, na.strings= c("", "NA"))
# participants$Date...CAH.Longitudinal.Data <- as.Date(participants$Date...CAH.Longitudinal.Data, format = "%d/%m/%Y")

medication <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/data/Glucocorticoids Data 24.02.2025.csv", header=T, na.strings= c("", "NA"))
medication <- remove_empty(medication, c("cols"), cutoff = 1)
# medication$assessment_date <- as.Date(medication$assessment_date, format = "%d/%m/%Y")

labs <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/data/Labs data 24.02.2025.csv", header=T, na.strings= c("", "NA"))
# labs$assessment_date <- as.Date(labs$assessment_date, format = "%d/%m/%Y")

longitudinal <- read.csv("C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/data/Longitudinal data 24.02.2025.csv", header=T, na.strings= c("", "NA"))

```

*********************************
Checking how similar this tranche is to one from Sept

Data is present in different frames to last time...

Notes:
- don't need 'First Presentation' data (not relevant info)
- don't need ae for this processing
- might need to merge dataframes...


```{r : merging data frames}
test <- merge(participants, longitudinal, by = "CO.ID",
              all = TRUE)

test$Date.of.Assessment <- as.Date(test$Date.of.Assessment, format = "%d/%m/%Y")
```
*********************************
*********************************
------Removing duplicates------

Making unique identifier for each assessment by combining co-id and assessment date.
```{r : making new unique identifier}
participants$coid_assedate <- paste(participants$CO.ID, participants$Date...CAH.Longitudinal.Data, sep = " ")
```

Checking for any duplicate entries (i.e.: any duplicates in the newly made unique identifier).
'list of duplicates frame' gives output of duplicate candidates
```{r : checking for duplicates}
duplicates <- freq(participants$coid_assedate)
duplicatesframe <- as.data.frame(duplicates)
duplicatesframe <- rownames_to_column(duplicatesframe, var="idvisitdate")
```

Now to remove any non-duplicates in 'duplicatesframe' to show us what the actual duplicates are and how many times they've been duplicated
```{r : isolating duplicate occurances, include= FALSE}
duplicatesframe <- duplicatesframe[duplicatesframe$idvisitdate != c("Total", "<NA>"),]
duplicatesframe <- duplicatesframe[-c(3:6)]

duplicateassessments <- duplicatesframe %>%
  filter(Freq>1)
```

Make a new vector to use as list of duplicate entries to remove from participants dataframe and then remove duplicated entries from participants dataframe with a subset.
Because there's no way of knowing which duplicate entry is the correct one, all duplicates are removed.
```{r : removing duplicates, include=FALSE}
idvisitstoremove <- duplicateassessments$idvisitdate

participantsnoduplicates <- subset(participants, !coid_assedate %in% idvisitstoremove)

freqcheck <- as.data.frame(freq(participantsnoduplicates$coid_assedate))
freqcheck <- rownames_to_column(freqcheck, var="idvisitdate")
freqcheck <- freqcheck[freqcheck$idvisitdate != c("Total", "<NA>"),]
# freqcheck
```

Making a dataframe of the removed duplicate assessment entries
```{r : removed duplicates}
toremove <- duplicateassessments$idvisitdate
removedrecords <- subset(participants, coid_assedate %in% toremove)

write.csv(removedrecords, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/removed_records", row.names = F)
```

Because I've removed all duplicate assessment entries, we might have lost participant/s if their only entry is one of these removed duplicates.
This will show which participants, if any, have been lost.
We need to split apart the idvisitdate to get the CO.IDs isolated
```{r : identifying lost participants}
duplicateassessments$id <- sapply(strsplit(duplicateassessments$idvisitdate," "), `[`, 1)
duplicateassessments$visitdate<- sapply(strsplit(duplicateassessments$idvisitdate," "), `[`, 2)

toremovelostparticipants <- participantsnoduplicates$CO.ID

lostparticipants <- NA
lostparticipants <- subset(participants, !CO.ID %in% toremovelostparticipants)

write.csv(lostparticipants, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/lostparticipants.csv", row.names = F)
```


```{r : making participantsnoduplicates}
idvisitstoremove <- duplicateassessments$idvisitdate

participantsnoduplicates <- subset(participants, !coid_assedate %in% idvisitstoremove)

freqcheck <- as.data.frame(freq(participantsnoduplicates$coid_assedate))
freqcheck <- rownames_to_column(freqcheck, var="idvisitdate")
freqcheck <- freqcheck[freqcheck$idvisitdate != c("Total", "<NA>"),]
```

*********************************
*********************************
------Making dataframes------

```{r : sex distribution}
# NEW
sex_distribution <- select(participants, Sex.at.birth)

sex_stats <- sex_distribution %>%
  group_by(Sex.at.birth) %>%
  summarise(n = n())

write.csv(sex_stats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/sex_stats.csv", row.names = F)
```

Let's do the same for visit statistics.
```{r : visit statistics}
visitsperparticipant <- test %>%
  group_by(CO.ID) %>%
  summarise(n=n())

overallvisitsstats <- visitsperparticipant %>%
  summarise("total number of patients" = n(),
            meanvisits = mean(n, na.rm = TRUE),
            medianvisits = median(n, na.rm = TRUE),                                            
            sdvisits = sd(n, na.rm = TRUE),
            minvisits = min(n, na.rm = TRUE),
            maxvisits = max(n, na.rm = TRUE)) %>%
  round(digits = 2)

overallvisitsstats$total_visits <- sum(visitsperparticipant$n)
```

Let's do patients and visits per centre
```{r : patients per centre}
patients_per_centre <- test %>%
  group_by(Centre.ID.x) %>%
  summarise(n_unique(CO.ID)) %>%
  as.data.frame() %>%
   rename("number of patients" = "n_unique(CO.ID)")
```

```{r : visits per centre}
visits_per_centre <- test %>%
  group_by(Centre.ID.x) %>%
  summarise(n = n()) %>%
  rename("number of visits" = "n")
```

```{r : combining patient and visit stats}
centre_stats <- full_join(patients_per_centre, visits_per_centre, by = "Centre.ID.x")

write.csv(centre_stats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/centre_stats.csv", row.names = F)
```

Age distributions
```{r : age distributions}
# NEW
participants$Date.of.Birth <- as.Date(participants$Date.of.Birth, format = "%d/%m/%Y")

Today = Sys.Date()

participants$Age <- as.numeric((Today - participants$Date.of.Birth) / 365)

participants$Age.category <-
  cut(participants$Age,
      breaks = c(0,10,20,30,40,50,60,70,80,90,100),
      labels = c("0-10", "11-20", "21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90", "91-100"))

ages <- select(participants, Age.category,)

age_distribution <- ages %>%
  group_by(Age.category) %>%
  summarise(n = n())

write.csv(age_distribution, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/age_distribution.csv", row.names = F)

# N.B: if an age category is empty here (i.e. no one of that age) then it is omitted from this table
```

```{r : age stats}
age_stats <- participants %>%
  summarise(median_age = median(participants$Age),
            max_age = max(participants$Age),
            min_age = min(participants$Age))

write.csv(age_stats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/age_stats.csv", row.names = F)
```


*********************************
*********************************
------Medication: cleaning ------

Let's start by cleaning medication data frame (units, typos, standardised doses)
Create unique identifier of coid_assedate
```{r : medication data frames}
medication_clean <- medication
medication_clean$coid_asse_id <- paste(medication_clean$CO.ID, medication_clean$assessment_id)

# note column is always empty / "NULL", so remove it
medication_clean <- select(medication_clean, -"Note")

medication_clean <- medication_clean %>%
  rename("assessment_id" = "Assessment.ID")


# Adding assessment date to medication_clean
test2 <- select(longitudinal, c("Assessment.ID", "Date.of.Assessment"))
test2 <- test2 %>%
  rename("assessment_id" = "Assessment.ID")

medication_clean <- left_join(medication_clean, test2, by = c("assessment_id"))

medication_clean$Date.of.Assessment <- as.Date(medication_clean$Date.of.Assessment, format = "%d/%m/%Y")
```

Now let's check what units have been used to see if we need to standardise any...
Assuming that NULL units are also mg.
```{r : clean medication units}
print("Let's see which units have been used:")
table(medication_clean$Unit)

# identify entries which used anomalous units
units_mcg <- subset(medication_clean, Unit == "mcg")

#correct the dose value by /1000 (mcg to mg)
medication_clean$Dose <-
  ifelse(medication_clean$Unit == "mcg",
         as.numeric(medication_clean$Dose) / 1000,
         as.numeric(medication_clean$Dose))

#correct the unit name (also include the NULL units here) - MIGHT WANT TO REMOVE THIS TO ALLOW QUALITY CHECKING LATER - MAYBE SOME ENTRIES INCLUDE MCG VALUES BUT SAY THEY'RE MG...
medication_clean$Unit <-
  ifelse(medication_clean$Unit == "mcg" | medication_clean$Unit == "NULL",
         as.character("mg"),
         as.character(medication_clean$Unit))

#checking that all units are the same (mcg)
table(medication_clean$Unit)
```

For direct medication comparisons to be useful, we need to convert prednisolone and dexamethasone doses to HC equivalent doses.
```{r : standardise medication doses}
prednisoloneratio <- 5
dexamethasoneratio <- 80

medication_clean$Standardised.doses <- NA
medication_clean$Standardised.doses <- as.character(medication_clean$Standardised.doses)

medication_clean$Standardised.doses <- 
  ifelse(medication_clean$Medicine == "Hydrocortisone", medication_clean$Dose, NA)

medication_clean$Standardised.doses <- 
  ifelse(medication_clean$Medicine == "Prednisolone", (as.numeric(medication_clean$Dose) * prednisoloneratio), medication_clean$Standardised.doses)

medication_clean$Standardised.doses <- 
  ifelse(medication_clean$Medicine == "Dexamethasone", (as.numeric(medication_clean$Dose) * dexamethasoneratio), medication_clean$Standardised.doses)

# medication_clean$Standardised.doses <- 
#   ifelse(medication_clean$Medicine == "Other", medication_clean$Dose, NA)
```

To check that the modified values seem sensible, let's run some basic stats to check for outliers/abnormal values.
I DON'T REALLY KNOW WHAT ARE SENSIBLE RANGES/VALUES...
```{r : basic med stats for outliers}
# Let's do it first using individual doses
checkmedstats <- medication_clean %>%
  group_by(Medicine) %>%
  summarise(mean_dose = mean(Standardised.doses, na.rm = TRUE),
            median_dose = median(Standardised.doses, na.rm = TRUE),
            sd_dose = sd(Standardised.doses, na.rm = TRUE),
            min_dose = min(Standardised.doses, na.rm = TRUE),
            max_dose = max(Standardised.doses, na.rm = TRUE)) %>%
  mutate_if(is.numeric, ~round(., 2))

# Now let's do it for total_daily_doses
medperpatient <- medication_clean %>%
  group_by(assessment_id) %>%
  summarise(total_standardised_daily_dose_1 = sum(Standardised.doses, na.rm = TRUE))

medication_clean <- full_join(medication_clean, medperpatient, by = "assessment_id")

checkdailymedstats <- medication_clean %>%
  group_by(Medicine) %>%
  summarise(mean_standardised_dose = mean(total_standardised_daily_dose_1, na.rm = TRUE),
            median_standardised_dose = median(total_standardised_daily_dose_1, na.rm = TRUE),
            sd_standardised_dose = sd(total_standardised_daily_dose_1, na.rm = TRUE),
            min_standardised_dose = min(total_standardised_daily_dose_1, na.rm = TRUE),
            max_standardised_dose = max(total_standardised_daily_dose_1, na.rm = TRUE)) %>%
  mutate_if(is.numeric, ~round(., 2))
```

```{r : time of medication dose}
medication_clean$Time <-
  ifelse(medication_clean$Time!=0,
         as.numeric(medication_clean$Time),
         NA)

medication_clean$dose_time_hours <- as.numeric(medication_clean$Time / 3600)

# times show up as 8.0 (for 8am), 21.0 (for 9pm) etc. This is useful for subsequent analysis using time :)
```

*********************************
*********************************
------Medication: making meds_wide ------
A single patient visit may have more than one entry in the medication frame (multiple entries for multiple doses recorded at the same visit). Therefore, we need to widen the medication frame to put each duplicate visit for a new dose into a single row for a single visit.
```{r : making meds_wide}
medication_clean$assessment_entry <-
  ave(medication_clean$CO.ID,
      medication_clean$assessment_id,
      FUN = seq_along)

totalmed_1st_entry <- 
  medication_clean %>% 
  filter(assessment_entry==1)

totalmed_2nd_entry <- 
  medication_clean %>% 
  filter(assessment_entry==2)

totalmed_3rd_entry <- 
  medication_clean %>% 
  filter(assessment_entry==3)

totalmed_4th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==4)

totalmed_5th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==5)

totalmed_6th_entry <- 
  medication_clean %>% 
  filter(assessment_entry==6)

#now we can get rid of the assessment entry column
# medication$assessment_entry <- NULL

totalmed_1st_entry$assessment_entry <- NULL

totalmed_2nd_entry$assessment_entry <- NULL

totalmed_3rd_entry$assessment_entry <- NULL

totalmed_4th_entry$assessment_entry <- NULL

totalmed_5th_entry$assessment_entry <- NULL

totalmed_6th_entry$assessment_entry <- NULL

#then add the appropriate suffix based on the assessment_entry number to each column in these frames to make them different before joining
colnames(totalmed_1st_entry) <- 
  paste(colnames(totalmed_1st_entry), 1, sep="_")

colnames(totalmed_2nd_entry) <- 
  paste(colnames(totalmed_2nd_entry), 2, sep="_")

colnames(totalmed_3rd_entry) <- 
  paste(colnames(totalmed_3rd_entry), 3, sep="_")

colnames(totalmed_4th_entry) <- 
  paste(colnames(totalmed_4th_entry), 4, sep="_")

colnames(totalmed_5th_entry) <- 
  paste(colnames(totalmed_5th_entry), 5, sep="_")

colnames(totalmed_6th_entry) <- 
  paste(colnames(totalmed_6th_entry), 6, sep="_")

totalmed_1st_entry <- totalmed_1st_entry %>%
  rename("CO.ID" = "CO.ID_1",
         "assessment_id" = "assessment_id_1")

totalmed_2nd_entry <- totalmed_2nd_entry %>%
  rename("CO.ID" = "CO.ID_2",
         "assessment_id" = "assessment_id_2")

totalmed_3rd_entry <- totalmed_3rd_entry %>%
  rename("CO.ID" = "CO.ID_3",
         "assessment_id" = "assessment_id_3")

totalmed_4th_entry <- totalmed_4th_entry %>%
  rename("CO.ID" = "CO.ID_4",
         "assessment_id" = "assessment_id_4")

totalmed_5th_entry <- totalmed_5th_entry %>%
  rename("CO.ID" = "CO.ID_5",
         "assessment_id" = "assessment_id_5")

totalmed_6th_entry <- totalmed_6th_entry %>%
  rename("CO.ID" = "CO.ID_6",
         "assessment_id" = "assessment_id_6")
```

```{r : joining widened med frames together}
meds_wide <- totalmed_1st_entry %>%
  left_join(totalmed_2nd_entry, by=c("CO.ID", "assessment_id")) %>%
  left_join(totalmed_3rd_entry, by=c("CO.ID", "assessment_id")) %>%
  left_join(totalmed_4th_entry, by=c("CO.ID", "assessment_id")) %>%
  left_join(totalmed_5th_entry, by=c("CO.ID", "assessment_id")) %>%
  left_join(totalmed_6th_entry, by=c("CO.ID", "assessment_id"))

#add in 'total daily dose' from 'medperpatient' to meds_wide
totaldailyformedswide <- select(medperpatient, c("assessment_id", "total_standardised_daily_dose_1"))

meds_wide <- meds_wide %>%
  left_join(select(medperpatient, assessment_id, total_standardised_daily_dose_1), by = "assessment_id")

meds_wide <- meds_wide %>%
  select_if(function(x) !all(is.na(x)))

write.csv(meds_wide, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/meds_wide.csv", row.names = F)

```
Now we have a single line per visit and all doses in a single row.

Now to add in the number of doses onto 'medperpatient' (couldn't do this earlier because widening meds is what introduces assessment entry numbers)
```{r : doses per patient}
medperpatient$number_of_doses <- medication_clean %>%
  group_by(assessment_id) %>%
  summarise(max(assessment_entry))

patient_medicine <- select(meds_wide, c("assessment_id", "Medicine_1"))
patient_w_h <- select(longitudinal, c("Assessment.ID", "Weight..kg.", "Height..cm."))
absolute_med_values <- select(meds_wide, )


medperpatient <- left_join(medperpatient, patient_medicine, by = "assessment_id")
medperpatient <- left_join(medperpatient, patient_w_h, join_by("assessment_id" == "Assessment.ID"))

write.csv(medperpatient, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/medperpatient.csv", row.names = F)
```

*********************************
*********************************
------Medication: stats ------

Start with working out how many visits each participant had where medication data was recorded
```{r : medication entries}
medicationentries <- medication_clean %>%
  group_by(assessment_id) %>%
  summarise(n = n())
```

```{r : medication stats}
overallvisitsstats$visitswithmed <- n_unique(meds_wide$assessment_id)

overallvisitsstats$patientswithmed <- n_unique(meds_wide$CO.ID)

write.csv(overallvisitsstats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/overallvisitsstats.csv", row.names = F)
```

Let's have a look at prescription habits
```{r : prescriptions - medicines}
medication_clean$prescribedmedperpatient <- paste(medication_clean$coid_asse_id, medication_clean$Medicine)
  
medprescriptions <- subset(medication_clean, assessment_entry == 1)

all_prescriptions <- medprescriptions %>%
  group_by(Medicine) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Medicine,
              values_from = n) %>%
  select(1,2,5,4,3)

prescriptions_last_12m <- medprescriptions %>%
  group_by(Medicine) %>%
  filter(Date.of.Assessment >= "2024-02-07") %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Medicine,
              values_from = n)

prescriptions_1_to_5_yrs <- medprescriptions %>%
  group_by(Medicine) %>%
  filter(Date.of.Assessment < "2024-02-07") %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = Medicine,
              values_from = n)


write.csv(all_prescriptions, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/all_prescriptions.csv", row.names = F)

write.csv(prescriptions_last_12m, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/prescriptions_last_12m.csv", row.names = F)

write.csv(prescriptions_1_to_5_yrs, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/prescriptions_1_to_5_yrs.csv", row.names = F)

othermeds <- subset(medication_clean, Medicine == "Other")
```

Let's try to work out how many patients are on a single medication or combined.
Within medtherapy frame, each row shows all medications, recorded in a single visit, taken in a single day by a single patient.
~ need to be careful when one patient has more than one visit in the same timeframe because each visit will be its own row of data and will be counted as two separate people...
```{r : medication therapies}
# make a new data frame with just medicine type
medtherapy <- select(meds_wide, c("CO.ID", "assessment_id", "Date.of.Assessment_1", "Medicine_1", "Medicine_2", "Medicine_3", "Medicine_4"))

medtherapy_last12m_frame <- medtherapy %>%
  filter(Date.of.Assessment_1 >= "2024-02-07")

medtherapy_1_to_5_years_frame <- medtherapy %>%
  filter(Date.of.Assessment_1 < "2024-02-07")

# need to work out how to make a legit output for seeing how many patients are on multiple medications simultaneously, but for now, this code works.
blah <- apply(medtherapy, 1, function(x) length (unique(x)))
blah <- as.data.frame(blah)

medtherapy_last12m <- apply(medtherapy_last12m_frame, 1, function(x) length (unique(x)))
medtherapy_last12m <- as.data.frame(medtherapy_last12m)

medtherapy_1_to_5_years <- apply(medtherapy_1_to_5_years_frame, 1, function(x) length (unique(x)))
medtherapy_1_to_5_years <- as.data.frame(medtherapy_1_to_5_years)

# https://stackoverflow.com/questions/74737100/how-to-check-if-multiple-columns-are-row-wise-equivalent-ignoring-na-values
```


*********************************
*********************************
------Medication: making labs_wide ------

```{r : labs_wide, include=FALSE}
valuesdrop <- c("Result", "assessments.content.labs.date_and_time_lab", "Time")
labsvalues <- labs[, !names(labs) %in% valuesdrop]
labsvalues <- labsvalues %>%
  pivot_wider(names_from = "Type",
              values_from = "Value")

interpdrop <- c("Value", "assessments.content.labs.date_and_time_lab", "Time")
labsinterp <- labs[, !names(labs) %in% interpdrop]
labsinterp <- labsinterp %>%
  pivot_wider(names_from = "Type",
              values_from = "Result")

labs_wide <- left_join(labsvalues, labsinterp, by = c("CO.ID", "Assessment.ID", "Date"))

names(labs_wide) <- gsub(x = names(labs_wide), pattern = ".x",
                        replacement = ".value")
names(labs_wide) <- gsub(x = names(labs_wide), pattern = ".y",
                        replacement = ".interpretation")
```

Reorder columns so that lab value and interpretation are next to eachother.
Check which columns are missing and remove so this can work.
```{r : putting lab values and interps next to eachother}
# labsorder <- c("CO.ID", "Assessment.ID", "Date", "Total_testosterone.value", "Total_testosterone.interpretation", "Sodium.value", "Sodium.interpretation", "Potassium.value", "Potassium.interpretation", "acth.value", "acth.interpretation", "cortisol.value", "cortisol.interpretation", "glucose.value", "glucose.interpretation", "renin.value", "renin.interpretation", "ohp17.value", "ohp17.interpretation", "andostenedione.value", "andostenedione.interpretation", "shbg.value", "shbg.interpretation", "haemoglobin.value", "haemoglobin.interpretation", "haematocrit.value", "haematocrit.interpretation", "lh.value", "lh.interpretation", "fsh.value", "fsh.interpretation", "dheas.value", "dheas.interpretation","oestradiol.value", "oestradiol.interpretation", "progesterone.value", "progesterone.interpretation", "plasma_renin_activi.interpretation.value", "plasma_renin_activi.interpretation.interpretation", "urine_steroids_.interpretation_gcms.value", "urine_steroids_.interpretation_gcms.interpretation", "di.interpretationdrotestosterone.value", "di.interpretationdrotestosterone.interpretation")
# labs_wide <- labs_wide[, labsorder]
```

Let's extract required labs info for CAH biomarkers 17-OHP and andro
```{r : labs biomarker subset}
CAH_biomarkers <- select(labs_wide, c("Assessment.ID", "CO.ID", "Date", "17-OHP.value", "17-OHP.interpretation", "Androstenedione.value", "Androstenedione.interpretation", "Renin.value", "Renin.interpretation", "Total testosterone.value", "Total testosterone.interpretation", "Glucose.value", "Glucose.interpretation"))

# 17-OHP
CAH_biomarkers$`17-OHP.unit` <- str_extract(CAH_biomarkers$`17-OHP.value`, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$`17-OHP.value` <- as.numeric(str_extract(CAH_biomarkers$`17-OHP.value`, "[0-9]+.?[0-9]*+"))

# androstenedione
CAH_biomarkers$`Androstenedione.unit` <- str_extract(CAH_biomarkers$`Androstenedione.value`, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$`Androstenedione.value` <- as.numeric(str_extract(CAH_biomarkers$`Androstenedione.value`, "[0-9]+.?[0-9]*+"))

# testosterone
CAH_biomarkers$`Total.testosterone.unit` <- str_extract(CAH_biomarkers$`Total testosterone.value`, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$`Total testosterone.value` <- as.numeric(str_extract(CAH_biomarkers$`Total testosterone.value`, "[0-9]+.?[0-9]*+"))

# renin
CAH_biomarkers$`Renin.unit` <- str_extract(CAH_biomarkers$`Renin.value`, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$`Renin.value` <- as.numeric(str_extract(CAH_biomarkers$`Renin.value`, "[0-9]+.?[0-9]*+"))

CAH_biomarkers$Renin.plasma.activity <- (CAH_biomarkers$Renin.value * 0.158)
CAH_biomarkers$Renin.plasma.activity <- round(CAH_biomarkers$Renin.plasma.activity, digits = 2)

# glucose
CAH_biomarkers$Glucose.unit <- str_extract(CAH_biomarkers$Glucose.value, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+")

CAH_biomarkers$Glucose.value <- as.numeric(str_extract(CAH_biomarkers$Glucose.value, "[0-9]+.?[0-9]*+"))

CAH_biomarkers_order <- c("Assessment.ID", "CO.ID", "Date", "17-OHP.value", "17-OHP.unit", "17-OHP.interpretation", "Androstenedione.value", "Androstenedione.unit", "Androstenedione.interpretation", "Renin.value", "Renin.unit", "Renin.interpretation", "Renin.plasma.activity", "Total testosterone.value", "Total.testosterone.unit", "Total testosterone.interpretation", "Glucose.value", "Glucose.interpretation")
CAH_biomarkers <- CAH_biomarkers[, CAH_biomarkers_order]

write.csv(CAH_biomarkers, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/CAH_biomarkers.csv", row.names = F)

# Now time frames
CAH_biomarkers$Date <- as.Date(CAH_biomarkers$Date, format = "%d/%m/%Y")

CAH_biomarkers_last12m <- CAH_biomarkers %>%
  filter(Date >= "2024-02-07")

CAH_biomarkers_1_to_5_yrs <- CAH_biomarkers %>%
  filter(Date < "2024-02-07")

write.csv(CAH_biomarkers_last12m, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/CAH_biomarkers_last12m.csv", row.names = F)

write.csv(CAH_biomarkers_1_to_5_yrs, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/CAH_biomarkers_1_to_5_yrs.csv", row.names = F)
```

```{r}
glucose <- select(CAH_biomarkers, c("Glucose.value"))
glucose_last_12m <- select(CAH_biomarkers_last12m, c("Glucose.value"))
glucose_1_to_5_yrs <- select(CAH_biomarkers_1_to_5_yrs, c("Glucose.value"))

write.csv(glucose_last_12m, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/glucose_last_12m.csv", row.names = F)

write.csv(glucose_1_to_5_yrs, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/glucose_1_to_5_yrs.csv", row.names = F)
```


Add labs stats onto 'overall visit stats' and make new frames for per centre.
```{r}
overallvisitsstats$number_of_labs_entries <- length(labs_wide$CO.ID)
overallvisitsstats$number_of_lab_patients <- n_unique(labs_wide$CO.ID)

write.csv(overallvisitsstats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/overallvisitsstats.csv", row.names = F)
```

BMI info
```{r : BMI}
BMIframe <- select(longitudinal, c("Assessment.ID", "Date.of.Assessment", "BMI"))

BMIframe$Class <- ""
BMIframe$Class [BMIframe$BMI <18.5] <- "Underweight"
BMIframe$Class [BMIframe$BMI >= 18.5 & BMIframe$BMI <25] <- "Normal"
BMIframe$Class [BMIframe$BMI >= 25 & BMIframe$BMI <30] <- "Overweight"
BMIframe$Class [BMIframe$BMI >=30 & BMIframe$BMI <35] <- "Obese"
BMIframe$Class [BMIframe$BMI >=35] <- "Extremely obese"
BMIframe$Class[BMIframe$Class == ""] <- "Missing"

BMIstats <- BMIframe %>%
  group_by(Class) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "Class",
              values_from = "n") %>%
  select(1,4,5,6,3,2)

# time frames
BMIframe_last_12m <- BMIframe %>%
  filter(Date.of.Assessment >= "2024-02-07")

BMIstats_last_12m <- BMIframe_last_12m %>%
  group_by(Class) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "Class",
              values_from = "n") %>%
  select(1,4,5,6,3,2)

BMIframe_1_to_5_yrs <- BMIframe %>%
  filter(Date.of.Assessment < "2024-02-07")

BMIstats_1_to_5_yrs <- BMIframe_1_to_5_yrs %>%
  group_by(Class) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "Class",
              values_from = "n") %>%
  select(1,4,5,6,3,2)

write.csv(BMIstats_last_12m, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/BMIstats_last_12m.csv", row.names = F, na = "")

write.csv(BMIstats_1_to_5_yrs, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/BMIstats_1_to_5_yrs.csv", row.names = F, na = "")
```


```{r : blood pressure}
# just need to extract blood pressure columns
blood_pressures <- select(longitudinal, c("Assessment.ID", "CO.ID", "Date.of.Assessment", "Systolic.Blood.Pressure", "Diastolic.Blood.Pressure"))

blood_pressures$Class <- ""

# normal
blood_pressures$Class [blood_pressures$Systolic.Blood.Pressure <= 120 & blood_pressures$Diastolic.Blood.Pressure < 80] <- "Normal"

# elevated
blood_pressures$Class [blood_pressures$Systolic.Blood.Pressure >= 120 & blood_pressures$Systolic.Blood.Pressure < 129 & blood_pressures$Diastolic.Blood.Pressure <80] <- "Elevated"

# Hypertension Stage 1
blood_pressures$Class [blood_pressures$Systolic.Blood.Pressure >= 130 & blood_pressures$Systolic.Blood.Pressure < 139 | blood_pressures$Diastolic.Blood.Pressure >= 80 & blood_pressures$Diastolic.Blood.Pressure < 89] <- "Hypertension Stage 1"

# Hypertension Stage 2
blood_pressures$Class [blood_pressures$Systolic.Blood.Pressure >= 140 & blood_pressures$Systolic.Blood.Pressure < 180 | blood_pressures$Diastolic.Blood.Pressure >= 90 & blood_pressures$Diastolic.Blood.Pressure < 120] <- "Hypertension Stage 2"

# Hypertension Stage 2 (or)
blood_pressures$Class [blood_pressures$Systolic.Blood.Pressure >= 180 |  blood_pressures$Diastolic.Blood.Pressure >= 90] <- "Hypertension Stage 2"

# Hypertension Stage 2 (and)
blood_pressures$Class [blood_pressures$Systolic.Blood.Pressure >= 180 &  blood_pressures$Diastolic.Blood.Pressure >= 90] <- "Hypertension Stage 2"

write.csv(blood_pressures, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/blood_pressures.csv", row.names = F)
```


```{r : adding BMI data to labs_wide}
# labs_wide$coid_assedate <- paste(labs_wide$CO.ID, labs_wide$assessment_date)
# labs_wide$BMI <- NULL
# 
# ii <- 1
# for (ID in labs_wide$coid_assedate) {
#   BMI <- participantsnoduplicates$BMI...CAH.Longitudinal.Data[participantsnoduplicates$coid_assedate == ID]
#   if(!is_empty(BMI)){
#   labs_wide$BMI [ii] <- BMI}
#   ii <- ii + 1
# }
```


```{r : BMI stats, include=FALSE}
# NOT RUN IN FEB 2025
BMIframe <- select(labs_wide, c("Centre.ID", "assessment_date", "coid_assedate", "BMI"))

BMIframe$Class <- ""
BMIframe$Class [BMIframe$BMI <18.5] <- "Underweight"
BMIframe$Class [BMIframe$BMI >= 18.5 & BMIframe$BMI <25] <- "Normal"
BMIframe$Class [BMIframe$BMI >= 25 & BMIframe$BMI <30] <- "Overweight"
BMIframe$Class [BMIframe$BMI >=30 & BMIframe$BMI <35] <- "Obese"
BMIframe$Class [BMIframe$BMI >=35] <- "Extremely obese"
BMIframe$Class[BMIframe$Class == ""] <- "Missing"

BMIstats <- BMIframe %>%
  group_by(Centre.ID, Class) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "Class",
              values_from = "n") %>%
  select(1,4,5,6,3,2)

BMIstats$total_patients_with_BMI_data <- rowSums(BMIstats [, c(2:5)], na.rm = TRUE)

# time frames
BMIframe2023_2024 <- BMIframe %>%
  filter(assessment_date > "2023-12-01")

BMIstats2023_2024 <- BMIframe2023_2024 %>%
  group_by(Centre.ID, Class) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "Class",
              values_from = "n") %>%
  select(1,4,5,6,3,2)

BMIstats2023_2024$total_patients_with_BMI_data <- BMIframe2023_2024 %>%
  group_by(Centre.ID) %>%
  summarise(n = n())

BMI2023_2024_no_entries <- anti_join(centreIDs2022_2024, BMIframe2023_2024, by = "Centre.ID")
BMIstats2023_2024 <- full_join(BMIstats2023_2024, BMI2023_2024_no_entries, by = "Centre.ID")
BMIstats2023_2024 <- BMIstats2023_2024 [order(BMIstats2023_2024$Centre.ID),]

write.csv(BMIstats2023_2024, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/BMIstats2023_2024.csv", row.names = F)

BMIframe2022_2023 <- BMIframe %>%
  filter(assessment_date < "2023-12-01" & assessment_date > "2022-12-01")

BMIstats2022_2023 <- BMIframe2022_2023 %>%
  group_by(Centre.ID, Class) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "Class",
              values_from = "n") %>%
  select(1,4,3,5,6,2)

BMIstats2022_2023$total_patients_with_BMI_data <- BMIframe2022_2023 %>%
  group_by(Centre.ID) %>%
  summarise(n = n())

BMI2022_2023_no_entries <- anti_join(centreIDs2022_2024, BMIframe2022_2023, by = "Centre.ID")
BMIstats2022_2023 <- full_join(BMIstats2022_2023, BMI2022_2023_no_entries, by = "Centre.ID")
BMIstats2022_2023 <- BMIstats2022_2023 [order(BMIstats2022_2023$Centre.ID),]

write.csv(BMIstats2022_2023, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/BMIstats2022_2023.csv", row.names = F)
```


*********************************
*********************************
------Biomarkers------
Now let's look at analysis of biomarkers - 17OHP, andostenedione, and renin.
Starting with 17OHP
```{r : 17-OHP, include=FALSE}
OHPframe <- select(labs_wide, c("Centre.ID", "assessment_id", "assessment_date", "ohp17.value", "ohp17.interpretation"))
OHPframe <- filter(OHPframe, !ohp17.interpretation == "NULL")
OHPframe$numericvalue <-as.numeric(str_extract(OHPframe$ohp17.value, "[0-9]+.?[0-9]*+"))
OHPframe$unit <- (str_extract(OHPframe$ohp17.value, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+"))

OHPframe_2023_2024 <- OHPframe %>%
  filter(assessment_date > "2023-12-01") %>%
  group_by(Centre.ID, ohp17.interpretation) %>%
  summarise(n = n()) %>%
 pivot_wider(names_from = "ohp17.interpretation",
             values_from = "n")

OHP2023_2024_no_entries <- anti_join(centreIDs2022_2024, OHPframe_2023_2024, by = "Centre.ID")
OHPframe_2023_2024 <- full_join(OHP2023_2024_no_entries, OHPframe_2023_2024, by = "Centre.ID")
OHPframe_2023_2024 <- OHPframe_2023_2024 [order(OHPframe_2023_2024$Centre.ID),]


OHPframe_2022_2023 <- OHPframe %>%
  filter(assessment_date < "2023-12-01" & assessment_date > "2022-12-01") %>%
  group_by(Centre.ID, ohp17.interpretation) %>%
  summarise(n = n()) %>%
 pivot_wider(names_from = "ohp17.interpretation",
             values_from = "n")

OHP2022_2023_no_entries <- anti_join(centreIDs2022_2024, OHPframe_2022_2023, by = "Centre.ID")
OHPframe_2022_2023 <- full_join(OHP2022_2023_no_entries, OHPframe_2022_2023, by = "Centre.ID")
OHPframe_2022_2023 <- OHPframe_2022_2023 [order(OHPframe_2022_2023$Centre.ID),]

write.csv(OHPframe_2023_2024, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/OHPframe_2023_2024.csv", row.names = F)
write.csv(OHPframe_2022_2023, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/OHPframe_2022_2023.csv", row.names = F)
```

Now let's do numerical analysis.
Check units
```{r : OHP numerical stats}
#check units, standardise if necessary
table(OHPframe$unit)

OHP2023_2024stats <- OHPframe %>%
  filter(assessment_date > "2023-12-01") %>%
  group_by(Centre.ID) %>%
  summarise(visits_with_OHP_data = n_unique(assessment_id),
            mean_value = mean(numericvalue, na.rm = TRUE),
            median_value = median(numericvalue, na.rm = TRUE),
            sd_value = sd(numericvalue, na.rm = TRUE),
            min_value = min(numericvalue, na.rm = TRUE),
            max_value = max(numericvalue, na.rm = TRUE)) %>%
  round(., digits = 2)
OHP2023_2024stats <- full_join(OHP2023_2024_no_entries, OHP2023_2024stats, by = "Centre.ID")
OHP2023_2024stats <- OHP2023_2024stats [order(OHP2023_2024stats$Centre.ID),]



OHP2022_2023stats <- OHPframe %>%
  filter(assessment_date < "2023-12-01" & assessment_date > "2022-12-01") %>%
  group_by(Centre.ID) %>%
  summarise(visits_with_OHP_data = n_unique(assessment_id),
            mean_value = mean(numericvalue, na.rm = TRUE),
            median_value = median(numericvalue, na.rm = TRUE),
            sd_value = sd(numericvalue, na.rm = TRUE),
            min_value = min(numericvalue, na.rm = TRUE),
            max_value = max(numericvalue, na.rm = TRUE)) %>%
  round(., digits = 2)
OHP2022_2023stats <- full_join(OHP2022_2023_no_entries, OHP2022_2023stats, by = "Centre.ID")
OHP2022_2023stats <- OHP2022_2023stats [order(OHP2022_2023stats$Centre.ID),]

write.csv(OHP2023_2024stats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/OHP2023_2024stats.csv", row.names = F)
write.csv(OHP2022_2023stats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/OHP2022_2023stats.csv", row.names = F)
```


```{r : andostenedione, include=FALSE}
Andoframe <- select(labs_wide, c("Centre.ID", "assessment_id", "assessment_date", "andostenedione.value", "andostenedione.interpretation"))
Andoframe <- filter(Andoframe, !andostenedione.interpretation == "NULL")
Andoframe$numericvalue <-as.numeric(str_extract(Andoframe$andostenedione.value, "[0-9]+.?[0-9]*+"))
Andoframe$unit <- (str_extract(Andoframe$andostenedione.value, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+"))

Andoframe_2023_2024 <- Andoframe %>%
  filter(assessment_date > "2023-12-01") %>%
  group_by(Centre.ID, andostenedione.interpretation) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = andostenedione.interpretation,
              values_from = n)

Ando2023_2024_no_entries <- anti_join(centreIDs2022_2024, Andoframe_2023_2024, by = "Centre.ID")
Andoframe_2023_2024 <- full_join(Ando2023_2024_no_entries, Andoframe_2023_2024, by = "Centre.ID")
Andoframe_2023_2024 <- Andoframe_2023_2024 [order(Andoframe_2023_2024$Centre.ID),]


Andoframe_2022_2023 <- Andoframe %>%
  filter(assessment_date < "2023-12-01" & assessment_date > "2022-12-01") %>%
  group_by(Centre.ID, andostenedione.interpretation) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = andostenedione.interpretation,
              values_from = n) %>%
  select(1,3,2,4)

Ando2022_2023_no_entries <- anti_join(centreIDs2022_2024, Andoframe_2022_2023, by = "Centre.ID")
Andoframe_2022_2023 <- full_join(Ando2022_2023_no_entries, Andoframe_2022_2023, by = "Centre.ID")
Andoframe_2022_2023 <- Andoframe_2022_2023 [order(Andoframe_2022_2023$Centre.ID),]

write.csv(Andoframe_2022_2023, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/Andoframe_2022_2023.csv", row.names = F)
write.csv(Andoframe_2023_2024, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/Andoframe_2023_2024.csv", row.names = F)
```

Numerical stats for ando too, now.
Check units and standardise where necessary.
```{r : ando numerical stats}
#check units, standardise if necessary
table(Andoframe$unit)

Ando2023_2024stats <- Andoframe %>%
  filter(assessment_date > "2023-12-01") %>%
  group_by(Centre.ID) %>%
  summarise(visits_with_ando_data = n_unique(assessment_id),
            mean_value = mean(numericvalue, na.rm = TRUE),
            median_value = median(numericvalue, na.rm = TRUE),
            sd_value = sd(numericvalue, na.rm = TRUE),
            min_value = min(numericvalue, na.rm = TRUE),
            max_value = max(numericvalue, na.rm = TRUE)) %>%
  round(., digits = 2)
Ando2023_2024stats <- full_join(Ando2023_2024_no_entries, Ando2023_2024stats, by = "Centre.ID")
Ando2023_2024stats <- Ando2023_2024stats [order(Ando2023_2024stats$Centre.ID),]


Ando2022_2023stats <- Andoframe %>%
  filter(assessment_date < "2023-12-01" & assessment_date > "2022-12-01") %>%
  group_by(Centre.ID) %>%
  summarise(visits_with_OHP_data = n_unique(assessment_id),
            mean_value = mean(numericvalue, na.rm = TRUE),
            median_value = median(numericvalue, na.rm = TRUE),
            sd_value = sd(numericvalue, na.rm = TRUE),
            min_value = min(numericvalue, na.rm = TRUE),
            max_value = max(numericvalue, na.rm = TRUE)) %>%
  round(., digits = 2)
Ando2022_2023stats <- full_join(Ando2022_2023_no_entries, Ando2022_2023stats, by = "Centre.ID")
Ando2022_2023stats <- Ando2022_2023stats [order(Ando2022_2023stats$Centre.ID),]

write.csv(Ando2023_2024stats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/Ando2023_2024stats.csv", row.names = F)
write.csv(Ando2022_2023stats, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/Ando2022_2023stats.csv", row.names = F)
```

Now renin.
If you're doing numerical stats, the raw renin values need to be converted to renin plasma activity. This is done by applying *0.158.
```{r : renin, include=FALSE}
Reninframe <- select(labs_wide, c("Assessment.ID", "Date", "Renin.value", "Renin.interpretation"))
Reninframe <- filter(Reninframe, !Renin.interpretation == "NULL")
Reninframe$numericvalue <-as.numeric(str_extract(Reninframe$Renin.value, "[0-9]+.?[0-9]*+"))
Reninframe$unit <- (str_extract(Reninframe$Renin.value, "[aA-zZ]+.?[aA-zZ]+.?[aA-zZ]*+"))
Reninframe$reninplasmaactivity <- (Reninframe$numericvalue * 0.158)
Reninframe$reninplasmaactivity <- round(Reninframe$reninplasmaactivity, digits = 2)

write.csv(Reninframe, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/Reninframe.csv", row.names = F)


# time frames

write.csv(Reninframe_2023_2024, file = "C:/Users/md1rwe/Documents/Data extractions from I-CAH/Feb 2025/I-CAH_data_Feb_2025/outputs/Reninframe_2023_2024.csv", row.names = F)
```

Now for renin numerical stats - remember the raw numbers here need to be converted to renin plasma activity (done by *0.158)
```{r : renin numerical stats}
#check units, standardise if necessary
table(Reninframe$unit)
#NEED CLARIFICATION ON UNITS AND SUBSEQUENT STANDARDISATION.
```

Let's make one table of all the processed biomarkers
Try re-naming columns in ^ tables to reflect biomarker
```{r}

```

*********************************

```{r}
# proportionsummary <- participantsnoduplicates %>%
#   group_by(coid_assedate) %>% 
#   summarise_each(funs(sum(!is.na(.))/length(.)))
# 
# variableproportions <- proportionsummary %>% summarise_each(mean)
# 
# variableproportionst <- t(variableproportions)
# variableproportionst <- as.data.frame(variableproportionst)
# variableproportionst <- rownames_to_column(variableproportionst, var="Var1")
# 
# names(variableproportionst)[names(variableproportionst)=="V1"] <- "averageproportiondata"
# 
# variablesinfo <- full_join(structure, variableproportionst, by = "Var1")
# names(variablesinfo)[names(variablesinfo)=="Length"] <- "n_visits"
```

Let's have a look now at data completeness.
In the dataframes made here, 0 = completely full, 1 = completely empty.
```{r : % missing data}
pcntMissing <- function(col) length(col[col == ""])/length(col)

# for participant data
participant_data_2023_2024 <- participantsnoduplicates %>%
  filter(Date...CAH.Longitudinal.Data > "2023-12-01")

missing_participant_data_2023_2024 <- participant_data_2023_2024 %>%
  group_by(Centre.ID) %>%
  summarise(across(everything(), pcntMissing)) %>%
  round(., digits = 2)  

participant_data_2022_2023 <- participantsnoduplicates %>%
  filter(Date...CAH.Longitudinal.Data < "2023-12-01" & Date...CAH.Longitudinal.Data > "2022-12-01")

missing_participant_data_2022_2023 <- participant_data_2022_2023 %>%
  group_by(Centre.ID) %>%
  summarise(across(everything(), pcntMissing)) %>%
  round(., digits = 2)  

# for lab data
pcntMissinglabs <- function(col) length(col[col == "NULL" | ""])/length(col)

lab_data_2023_2024 <- labs_wide %>%
  filter(assessment_date > "2023-12-01")

# missing_lab_data_2023_2024 <- lab_data_2023_2024 %>%
#   group_by(Centre.ID) %>%
#   summarise(across(everything(), pcntMissinglabs)) %>%
#   round(., digits = 2)

# for med data
pcntMissingmeds <- function(col) length(col[col == "NULL" | ""])/length(col)
```

```{r}
print("Script complete")
```


NOTES:
regarding patient numbers, ask NP when CaHASE2 started and filter patient numbers per centre since the study began (they might have old patients on the registry from e.g 10 years ago, who are registered and will be counted here but aren't actually relevant for CaHASE2).

What to do with 'other/NULL' medication (in terms of including in medication stuff). Units are sometimes 'NULL', and medicine is sometimes 'other' or 'NULL'.

For overallstats I need to separate them into the two timeframes.

Need to add in missing centres into dexamethasone prescription data frame.

Remove unnecessary column from BMI stats frames. Add in empty centres.

Add in empty centres to medication stat frames.
Add in empty centres to sex data frames
Add in empty centres to age data frames
Add in proportions to age data frames

Change 'number of visits' to 'number of entries' wherever this is used.

Missing data.

